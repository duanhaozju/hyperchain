package builtin

import (
	"fmt"
	"regexp"
	"strconv"
	"sync"
	"time"
)

var (
	NHcode = "0x6060604052612413806100126000396000f360606040523615610095576000357c01000000000000000000000000000000000000000000000000000000009004806332c1680c1461009a57806365a40f9c146100df578063b5cf8eab1461017b578063bf7716ac146101bd578063cb7f047214610219578063e7cfd66e146102ed578063e98e84d4146103c8578063ed29244f14610524578063ff86a1791461058057610095565b610002565b34610002576100c760048080359060200190919080359060200190919080359060200190919050506105c8565b60405180821515815260200191505060405180910390f35b346100025761010360048080359060200190919080359060200190919050506106db565b604051808360ff168152602001806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561016c5780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b346100025761018d6004805050610bf4565b60405180846000191681526020018360001916815260200182600019168152602001935050505060405180910390f35b34610002576101cf6004805050610c56565b60405180806020018281038252838181518152602001915080519060200190602002808383829060006004602084601f0104600302600f01f1509050019250505060405180910390f35b34610002576102346004808035906020019091905050610cf5565b604051808b6000191681526020018a815260200189600019168152602001888152602001878152602001866000191681526020018573ffffffffffffffffffffffffffffffffffffffff1681526020018473ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1681526020018273ffffffffffffffffffffffffffffffffffffffff1681526020019a505050505050505050505060405180910390f35b34610002576103506004808035906020019091908035906020019091908035906020019091908035906020019091908035906020019091908035906020019091908035906020019091908035906020019091908035906020019091905050610f7c565b604051808360ff168152602001806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103b95780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b34610002576103e360048080359060200190919050506114d3565b6040518087600019168152602001806020018060200180602001806020018060200186810386528b8181518152602001915080519060200190602002808383829060006004602084601f0104600302600f01f15090500186810385528a8181518152602001915080519060200190602002808383829060006004602084601f0104600302600f01f1509050018681038452898181518152602001915080519060200190602002808383829060006004602084601f0104600302600f01f1509050018681038352888181518152602001915080519060200190602002808383829060006004602084601f0104600302600f01f1509050018681038252878181518152602001915080519060200190602002808383829060006004602084601f0104600302600f01f1509050019b50505050505050505050505060405180910390f35b34610002576105366004805050611763565b60405180806020018281038252838181518152602001915080519060200190602002808383829060006004602084601f0104600302600f01f1509050019250505060405180910390f35b34610002576105a46004808035906020019091908035906020019091905050611802565b604051808360ff168152602001826000191681526020019250505060405180910390f35b60006000600102600260005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050600101600050546000191614156106ca5782600260005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506000016000508190555081600260005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000506002016000508190555083600260005060003373ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060005060010160005081905550600190506106d4566106d3565b600090506106d4565b5b9392505050565b600060206040519081016040528060008152602001506000600060006000600060007f535530300000000000000000000000000000000000000000000000000000000089600019161415610ab4573373ffffffffffffffffffffffffffffffffffffffff16600560005060008c600019168152602001908152602001600020600050600b0160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161415156107e6576001809050604060405190810160405280601481526020017f596f7520646f6e2774206861732061636365737300000000000000000000000081526020015097509750610be7565b6107ee610bf4565b95509550955061082c600360005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000508b611af9565b6108a460016000506000600560005060008e60001916815260200190815260200160002060005060080160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000508b611af9565b7f3030303030303300000000000000000000000000000000000000000000000000600560005060008c6000191681526020019081526020016000206000506009016000508190555033600560005060008c600019168152602001908152602001600020600050600a0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c0100000000000000000000000090810204021790555033600560005060008c60001916815260200190815260200160002060005060080160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c01000000000000000000000000908102040217905550600160005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000508054806001018281815481835581811511610a1e57818360005260206000209182019101610a1d91906109ff565b80821115610a1957600081815060009055506001016109ff565b5090565b5b5050509190906000526020600020900160005b8c90919091505550610a688a60017f5355303000000000000000000000000000000000000000000000000000000000898989611c00565b6000809050604060405190810160405280601481526020017f656e6472726573706f6e7365207375636365656400000000000000000000000081526020015097509750610be756610be6565b7f535530310000000000000000000000000000000000000000000000000000000089600019161415610be5577f3030303030303200000000000000000000000000000000000000000000000000600560005060008c60001916815260200190815260200160002060005060090160005081905550610b30610bf4565b925092509250610b658a60017f5355303100000000000000000000000000000000000000000000000000000000868686611c00565b610b9d600360005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000508b611af9565b6001809050604060405190810160405280601281526020017f656e64726573706f6e7365206661696c6564000000000000000000000000000081526020015097509750610be7565b5b5b5050505050509250929050565b6000600060006000600260005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000509050806000016000505481600101600050548260020160005054935093509350610c50565b50909192565b6020604051908101604052806000815260200150600360005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050805480602002602001604051908101604052809291908181526020018280548015610ce657602002820191906000526020600020905b816000505481526020019060010190808311610ccf575b50505050509050610cf2565b90565b60006000600060006000600060006000600060006000600560005060008d60001916815260200190815260200160002060005090503373ffffffffffffffffffffffffffffffffffffffff168160050160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161480610dd757503373ffffffffffffffffffffffffffffffffffffffff168160060160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b80610e3157503373ffffffffffffffffffffffffffffffffffffffff168160070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b80610e8b57503373ffffffffffffffffffffffffffffffffffffffff168160080160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15610f6d578060000160005054816001016000505482600201600050548360030160005054846004016000505485600901600050548660050160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168760060160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168860070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff168960080160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169a509a509a509a509a509a509a509a509a509a50610f6e565b5b509193959799509193959799565b6000602060405190810160405280600081526020015060006000888a101515610feb576001809050604060405190810160405280601a81526020017f69737375654461746520626967207468656e2064756564617465000000000000815260200150935093506114c3566114c2565b7f41433031000000000000000000000000000000000000000000000000000000008b600019161415801561104357507f41433032000000000000000000000000000000000000000000000000000000008b6000191614155b15611090576001809050604060405190810160405280601581526020017f62696c6c74797065206973206e6f74206d617463680000000000000000000000815260200150935093506114c3565b3373ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff1614151561110d576001809050604060405190810160405280601181526020017f64727772206973206e6f74206d61746368000000000000000000000000000000815260200150935093506114c3565b6000600102600560005060008f6000191681526020019081526020016000206000506000016000505460001916141515611189576001809050604060405190810160405280601581526020017f746869732062696c6c20707562656420616c7265610000000000000000000000815260200150935093506114c3565b600560005060008e6000191681526020019081526020016000206000509150600160005060008673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000508054806001018281815481835581811511611224578183600052602060002091820191016112239190611205565b8082111561121f5760008181506000905550600101611205565b5090565b5b5050509190906000526020600020900160005b8f909190915055508c82600001600050819055508b82600101600050819055508a8260020160005081905550898260030160005081905550888260040160005081905550878260050160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c01000000000000000000000000908102040217905550868260060160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c01000000000000000000000000908102040217905550858260070160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c01000000000000000000000000908102040217905550848260080160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c010000000000000000000000009081020402179055507f303030303030310000000000000000000000000000000000000000000000000082600901600050819055508482600a0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c010000000000000000000000009081020402179055508482600a0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c01000000000000000000000000908102040217905550600260005060003373ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600050905061147a8d60006000600102846000016000505485600101600050548660020160005054611c00565b6000809050604060405190810160405280601381526020017f70756242696c6c496e666f207375636365656400000000000000000000000000815260200150935093506114c3565b5b5050995099975050505050505050565b6000602060405190810160405280600081526020015060206040519081016040528060008152602001506020604051908101604052806000815260200150602060405190810160405280600081526020015060206040519081016040528060008152602001506000600060206040519081016040528060008152602001506020604051908101604052806000815260200150602060405190810160405280600081526020015060206040519081016040528060008152602001506020604051908101604052806000815260200150600560005060008f60001916815260200190815260200160002060005096503373ffffffffffffffffffffffffffffffffffffffff168760050160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16148061166d57503373ffffffffffffffffffffffffffffffffffffffff168760060160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b806116c757503373ffffffffffffffffffffffffffffffffffffffff168760070160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b8061172157503373ffffffffffffffffffffffffffffffffffffffff168760080160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b156117525761172f8e611eb4565b9550955095509550955095508585858585859c509c509c509c509c509c50611753565b5b5050505050505091939550919395565b6020604051908101604052806000815260200150600160005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000508054806020026020016040519081016040528092919081815260200182805480156117f357602002820191906000526020600020905b8160005054815260200190600101908083116117dc575b505050505090506117ff565b90565b6000600060007f303030303030320000000000000000000000000000000000000000000000000060056000506000876000191681526020019081526020016000206000506009016000505460001916141561188a5760018090507f686173206265656e20656e64720000000000000000000000000000000000000092509250611af156611af0565b3373ffffffffffffffffffffffffffffffffffffffff16600560005060008760001916815260200190815260200160002060005060080160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614151561192e5760018090507f596f7520646f6e2774206861732061636365737300000000000000000000000092509250611af1565b7f3030303030303200000000000000000000000000000000000000000000000000600560005060008760001916815260200190815260200160002060005060090160005081905550836005600050600087600019168152602001908152602001600020600050600b0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff02191690836c01000000000000000000000000908102040217905550600360005060008573ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000508054806001018281815481835581811511611a4d57818360005260206000209182019101611a4c9190611a2e565b80821115611a485760008181506000905550600101611a2e565b5090565b5b5050509190906000526020600020900160005b8790919091505550600260005060003373ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000509050611ac18560016000600102846000016000505485600101600050548660020160005054611c00565b60008090507f737563636573730000000000000000000000000000000000000000000000000092509250611af1565b5b509250929050565b60006000600090505b8380549050811015611b585782600019168482815481101561000257906000526020600020900160005b5054600019161415611b42578091508150611b58565b81806001019250505b8080600101915050611b02565b838054905082141515611bf957836001858054905003815481101561000257906000526020600020900160005b50548483815481101561000257906000526020600020900160005b508190555060018480549050038481815481835581811511611bf457818360005260206000209182019101611bf39190611bd5565b80821115611bef5760008181506000905550600101611bd5565b5090565b5b505050505b5b50505050565b60006000600050600088600019168152602001908152602001600020600050805490509050600060005060008860001916815260200190815260200160002060005080548091906001019090815481835581811511611cdb57600602816006028360005260206000209182019101611cda9190611c78565b80821115611cd657600060008201600050600090556001820160006101000a81549060ff0219169055600282016000506000905560038201600050600090556004820160005060009055600582016000506000905550600601611c78565b5090565b5b5050505086600060005060008960001916815260200190815260200160002060005082815481101561000257906000526020600020906006020160005b506000016000508190555085600060005060008960001916815260200190815260200160002060005082815481101561000257906000526020600020906006020160005b5060010160006101000a81548160ff02191690837f010000000000000000000000000000000000000000000000000000000000000090810204021790555084600060005060008960001916815260200190815260200160002060005082815481101561000257906000526020600020906006020160005b506002016000508190555083600060005060008960001916815260200190815260200160002060005082815481101561000257906000526020600020906006020160005b506003016000508190555082600060005060008960001916815260200190815260200160002060005082815481101561000257906000526020600020906006020160005b506004016000508190555081600060005060008960001916815260200190815260200160002060005082815481101561000257906000526020600020906006020160005b50600501600050819055505b50505050505050565b6000602060405190810160405280600081526020015060206040519081016040528060008152602001506020604051908101604052806000815260200150602060405190810160405280600081526020015060206040519081016040528060008152602001506000600060006000600060006000600091505b600060005060008f6000191681526020019081526020016000206000508054905082101561222357600060005060008f60001916815260200190815260200160002060005082815481101561000257906000526020600020906006020160005b509050868054806001018281815481835581811511611fec57601f016020900481601f01602090048360005260206000209182019101611feb9190611fcd565b80821115611fe75760008181506000905550600101611fcd565b5090565b5b505050919090600052602060002090602091828204019190065b8360010160009054906101000a900460ff16909190916101000a81548160ff02191690837f0100000000000000000000000000000000000000000000000000000000000000908102040217905550508580548060010182818154818355818115116120a3578183600052602060002091820191016120a29190612084565b8082111561209e5760008181506000905550600101612084565b5090565b5b5050509190906000526020600020900160005b8360020160005054909190915055508480548060010182818154818355818115116121135781836000526020600020918201910161211291906120f4565b8082111561210e57600081815060009055506001016120f4565b5090565b5b5050509190906000526020600020900160005b836003016000505490919091505550838054806001018281815481835581811511612183578183600052602060002091820191016121829190612164565b8082111561217e5760008181506000905550600101612164565b5090565b5b5050509190906000526020600020900160005b8360040160005054909190915055508280548060010182818154818355818115116121f3578183600052602060002091820191016121f291906121d4565b808211156121ee57600081815060009055506001016121d4565b5090565b5b5050509190906000526020600020900160005b8360050160005054909190915055505b8180600101925050611f2d565b8d87878787878480548060200260200160405190810160405280929190818152602001828054801561229757602002820191906000526020600020906000905b82829054906101000a900460ff16815260200190600101906020826000010492830192600103820291508084116122635790505b50505050509450838054806020026020016040519081016040528092919081815260200182805480156122ec57602002820191906000526020600020905b8160005054815260200190600101908083116122d5575b505050505093508280548060200260200160405190810160405280929190818152602001828054801561234157602002820191906000526020600020905b81600050548152602001906001019080831161232a575b505050505092508180548060200260200160405190810160405280929190818152602001828054801561239657602002820191906000526020600020905b81600050548152602001906001019080831161237f575b50505050509150808054806020026020016040519081016040528092919081815260200182805480156123eb57602002820191906000526020600020905b8160005054815260200190600101908083116123d4575b505050505090509c509c509c509c509c509c50612403565b505050505050509193955091939556"
	// NewUser
	NHmethod1 = "0x32c1680c100000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000000"
	// QueryUser
	NHmethod2 = "0xb5cf8eab"
)

func NHBANK(duration, tps, instant, estimation int, simulate bool) {
	_, globalAccounts = read(accountList, accountNumber)
	logger.Notice(len(globalAccounts))
	contractAddr, success := deploy()
	NHcontract = contractAddr
	if success == false {
		logger.Error("Deploy Failed!")
		return
	}
	newUser(contractAddr, globalAccounts)
	logger.Notice("New User Finish")
	time.Sleep(10 * time.Second)
	timeBegin := time.Now().UnixNano()
	getUserInfo(duration, tps, instant, simulate)
	timeEnd := time.Now().UnixNano()
	queryStatistic(timeBegin+int64(estimation)*time.Second.Nanoseconds(), timeEnd-int64(estimation)*time.Second.Nanoseconds(), globalNodes[2])
}
func deploy() (string, bool) {
	node := globalNodes[0]
	pattern, err := regexp.Compile(".*:..(.*):(.*)")
	if err != nil {
		return "", false
	}
	ret := pattern.FindStringSubmatch(string(node))
	if ret == nil || len(ret) < 3 {
		return "", false
	}
	ip := ret[1]
	port, _ := strconv.ParseInt(ret[2], 10, 64)
	resp, success := ExecuteTransaction(genesisPassword, globalAccounts[0], "", time.Now().UnixNano(), 0, NHcode, 1, ip, int(port), true, false)
	if success == false {
		return "", false
	} else {
		pattern, err := regexp.Compile(".*contractAddress...(.*?)\"")
		if err != nil {
			return "", false
		}
		ret := pattern.FindStringSubmatch(string(resp))
		if ret == nil || len(ret) < 2 {
			return "", false
		}
		logger.Notice("Deploy contract success! Contract Address:", ret[1])
		return ret[1], true
	}
}
func newUser(contractAddr string, accounts []string) {
	node := globalNodes[0]
	pattern, err := regexp.Compile(".*:..(.*):(.*)")
	if err != nil {
		return
	}
	ret := pattern.FindStringSubmatch(string(node))
	if ret == nil || len(ret) < 3 {
		return
	}
	ip := ret[1]
	port, _ := strconv.ParseInt(ret[2], 10, 64)
	logger.Notice(ip, port)
	// deploy account to blockchain
	for i := 0; i < len(accounts); i += 1 {
		command, success := NewTransaction(genesisPassword, "0x"+accounts[i], contractAddr, time.Now().UnixNano(), 0, NHmethod1, 1, ip, int(port), false, false)
		if success == false {
			logger.Error("create transaction failed")
		} else {
			pattern, _ := regexp.Compile(".*'(.*?)'")
			ret := pattern.FindStringSubmatch(command)
			if ret == nil || len(ret) < 2 {
				logger.Error("create transaction failed")
			}
			cmd := ret[1]
			logger.Notice(command)
			server := fmt.Sprintf("http://%s:%d", ip, port)
			resp, err := communication(cmd, server)
			if err != nil {
				logger.Error("execute transaction failed")
			} else {
				logger.Notice("Result:", string(resp))
			}
		}
	}
}
func getUserInfo(tps, instant, duration int, simulate bool) {
	if tps == 0 || instant == 0 {
		output(false, "invalid tps or instant parameter")
		return
	}
	start := time.Now().Unix()
	end := start + int64(duration)
	var interval time.Duration
	tmp := float64(instant) / float64(tps)
	if tmp >= 1 {
		output(false, "invalid tps or instant parameter")
		return
	} else if tmp >= 0.001 && tmp < 1 {
		interval = time.Duration(tmp*1000) * time.Millisecond
	} else if tmp < 0.001 && tmp >= 0.001*0.001 {
		interval = time.Duration(tmp*1000*1000) * time.Microsecond
	} else {
		interval = time.Duration(tmp*1000*1000*1000) * time.Nanosecond
	}
	logger.Notice("=============== Stress Test Begin ===============")
	logger.Notice("=============== Arguments =======================")
	logger.Notice("\tTPS: ", tps)
	logger.Notice("\tInstant Concurrency: ", instant)
	logger.Notice("\tDuration: ", duration)
	var wg sync.WaitGroup
	var testType int
	if simulate == true {
		testType = 3
	} else {
		testType = 2
	}
	for time.Now().Unix() < end {
		go sendBatch(globalNodes, len(globalNodes), instant, testType, 0, wg)
		time.Sleep(interval)
	}
	wg.Wait()
	logger.Notice("=============== Stress Test Finish ===============")
}
